@use 'sass:map';
@use "sass:meta";
@use 'sass:list';
@use 'variables' as *;

@function xyz-str-split($string, $separator: ' ') {
  $split-arr: ();
  $index : str-index($string, $separator);
  @while $index != null {
    $item: str-slice($string, 1, $index - 1);
    $split-arr: append($split-arr, $item);
    $string: str-slice($string, $index + 1);
    $index : str-index($string, $separator);
  }
  $split-arr: append($split-arr, $string);

  @return $split-arr;
}

@function xyz-mode-name($name, $mode: 'all') {
  @if $mode == 'all' {
    @return $name;
  }
  @return $mode + '-' + $name;
}

@function xyz-fallback-var($name, $mode: 'all', $fallback: 'default') {
  @if $fallback == 'default' {
    $fallback: var(--xyz-#{$name}-default);
  }
  @return var(--xyz-#{xyz-mode-name($name, $mode)}, var(--xyz-#{$name}, #{$fallback}));
}

@function xyz-utility-ease($level: 'ease') {
  @return map.get($xyz-utility-eases, $level);
}

@function xyz-utility-time($level: '0') {
  @return map.get($xyz-utility-times, $level);
}

@function xyz-utility-iteration($level: '0') {
  @return map.get($xyz-utility-iterations, $level);
}

@function xyz-utility-origin($level: 'center') {
  @return map.get($xyz-utility-origins, $level);
}

@function xyz-utility-fade($level: '0') {
  @return map.get($xyz-utility-fades, $level);
}

@function xyz-utility-translation($level: '0') {
  @return map.get($xyz-utility-translations, $level);
}

@function xyz-utility-rotation($level: '0') {
  @return map.get($xyz-utility-rotations, $level);
}

@function xyz-utility-scale($level: '0') {
  @return map.get($xyz-utility-scales, $level);
}

@mixin xyz-include-once($name) {
  @if (list.index($xyz-included, $name) == null) {
    $xyz-included: append($xyz-included, $name) !global;
    @content;
  }
}

@mixin xyz-set-all($val: initial) {
  @each $mode in $xyz-modes-all {
    --xyz-#{xyz-mode-name('keyframes', $mode)}: #{$val};

    --xyz-#{xyz-mode-name('ease', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('duration', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('delay', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('stagger', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('stagger-rev', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('iterate', $mode)}: #{$val};

    --xyz-#{xyz-mode-name('origin', $mode)}: #{$val};

    --xyz-#{xyz-mode-name('fade', $mode)}: #{$val};

    --xyz-#{xyz-mode-name('transform', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('translate-x', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('translate-y', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('translate-z', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('rotate-x', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('rotate-y', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('rotate-z', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('scale-x', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('scale-y', $mode)}: #{$val};
    --xyz-#{xyz-mode-name('scale-z', $mode)}: #{$val};
  }

  --xyz-#{xyz-mode-name('ease', 'move')}: #{$val};
  --xyz-#{xyz-mode-name('duration', 'move')}: #{$val};
  --xyz-#{xyz-mode-name('delay', 'move')}: #{$val};
}

@mixin xyz-make-variable-utilities($name, $vars, $default-val, $utility-map, $transform-func: null, $modes: $xyz-modes-all) {
  @each $mode in $modes {
    $class-name: xyz-mode-name($name, $mode);
    [xyz~=#{$class-name}] {
      @each $var in $vars {
        --xyz-#{xyz-mode-name($var, $mode)}: #{$default-val};
      }
    }
    @each $level, $val in $utility-map {
      $val: map.get($utility-map, $level);
      @if $transform-func {
        $val: meta.call($transform-func, $val);
      }
      [xyz~=#{$class-name}-#{$level}] {
        @each $var in $vars {
          --xyz-#{xyz-mode-name($var, $mode)}: #{$val};
        }
      }
    }
  }
}

@mixin xyz-make-keyframes-utilities($name) {
  @each $mode in $xyz-modes {
    $mode-name: xyz-mode-name($name, $mode);

    [xyz~=#{$name}], [xyz~=#{$mode-name}] {
      --xyz-#{xyz-mode-name('keyframes', $mode)}: xyz-#{$mode-name};
    }
  }
}

@mixin xyz-make-keyframes($name, $make-utilities: true) {
  @each $mode in $xyz-modes {
    $mode-name: xyz-mode-name($name, $mode);

    @keyframes xyz-#{$mode-name} {
      @content($mode);
    }
  }

  @if $make-utilities {
    @include xyz-make-keyframes-utilities($name);
  }
}

@mixin xyz-animation($mode) {
  $keyframes: xyz-fallback-var('keyframes', $mode, xyz-#{xyz-mode-name('keyframes', $mode)});
  $duration: xyz-fallback-var('duration', $mode);
  $ease: xyz-fallback-var('ease', $mode);
  $delay: xyz-fallback-var('delay', $mode, 0s);
  $stagger: xyz-fallback-var('stagger', $mode, 0s);
  $stagger-rev: xyz-fallback-var('stagger-rev', $mode, 0s);
  $iterate: xyz-fallback-var('iterate', $mode, 1);
  $origin: xyz-fallback-var('origin', $mode, center);

  $index: var(--xyz-index, 0);
  $index-rev: var(--xyz-index-rev, 0);

  $direction: normal;
  @if $mode == 'out' {
    $direction: reverse;
  }

  transform-origin: #{$origin};
  backface-visibility: visible;

  animation:
    #{$keyframes}
    #{$duration}
    #{$ease}
    calc(#{$delay} + #{$stagger} * #{$index} + #{$stagger-rev} * #{$index-rev})
    #{$iterate}
    #{$direction}
    both
    !important;

  @media (prefers-reduced-motion: reduce) {
    animation: none !important;
  }
}

@mixin xyz-in() {
  @include xyz-animation('in')
}

@mixin xyz-out() {
  @include xyz-animation('out')
}

@mixin xyz-appear() {
  @include xyz-animation('appear')
}

@mixin xyz($context: '') {
  $words: xyz-str-split($context);

  @extend [xyz];
  @each $word in $words {
    @extend [xyz~=#{$word}];
  }
}
